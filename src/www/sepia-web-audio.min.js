//SEPIA Web Audio Lib v0.9.7 min - https://github.com/SEPIA-Framework/sepia-web-audio
"object"==typeof SepiaFW||(SepiaFW={}),function(a){function b(){return k=!!j&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,!!k||void 0}function c(a,b){if(!a||!a.size)b();else if("function"==typeof a.arrayBuffer)a.arrayBuffer().then(function(a){b(a)}).catch(function(a){console.error("blobToArray '.arrayBuffer' ERROR",a),b()});else{var c=new FileReader;c.onload=function(){b(c.result)},c.onerror=function(a){console.error("blobToArray 'FileReader' ERROR",reader.error,a),b()},c.readAsArrayBuffer(a)}}function d(a){return new Promise(function(b,c){i.readFileAsBuffer(a,function(a){b(a)},function(a){c(a)})})}function e(a){return new Promise(function(b,c){i.readFileAsText(a,function(a){b(a)},function(a){c(a)})})}function f(a,b,c,d){var e=new XMLHttpRequest;e.open("GET",b),e.responseType=a,e.timeout=i.contentFetchTimeout,e.onload=function(){200<=e.status&&300>e.status?c(e.response):d({status:e.status,message:e.statusText})},e.onerror=function(a){d(a)},e.send()}function g(a){try{for(var b=atob(a),c=new Uint8Array(b.length),d=0;d<b.length;++d)c[d]=b.charCodeAt(d);return c}catch(a){throw new Error("Converting base64 string to bytes failed.")}}function h(){}var i=a.webAudio||{};i.version="0.9.7";var j=window.AudioContext||window.webkitAudioContext,k=void 0;i.isStreamRecorderSupported=b(),i.isNativeStreamResamplingSupported=!0,i.tryNativeStreamResampling=!0,i.contentFetchTimeout=8e3,i.defaultProcessorOptions={moduleFolder:"modules",initSuccessCallback:console.log,initErrorCallback:console.error,onerror:console.error},i.getSupportedAudioConstraints=function(){var a=navigator.mediaDevices.getSupportedConstraints(),b={},c=i.overwriteSupportedAudioConstraints;return a.deviceId&&(b.deviceId=null==c.deviceId?void 0:c.deviceId),a.channelCount&&(b.channelCount=null==c.channelCount?1:c.channelCount),a.noiseSuppression&&(b.noiseSuppression=null==c.noiseSuppression||c.noiseSuppression),a.autoGainControl&&(b.autoGainControl=null!=c.autoGainControl&&c.autoGainControl),a.echoCancellation&&(b.echoCancellation=null!=c.echoCancellation&&c.echoCancellation),a.sampleRate&&(b.sampleRate=null==c.sampleRate?48e3:c.sampleRate),b},i.overwriteSupportedAudioConstraints={},i.defaultMimeTypesForCodecs={ogg:"audio/ogg",ogg_opus:"audio/ogg;codecs=opus",ogg_vorbis:"audio/ogg;codecs=vorbis",ogg_speex:"audio/ogg;codecs=speex",opus:"audio/opus",vorbis:"audio/vorbis",speex:"audio/speex",wav:"audio/wav",raw:"audio/wav",webm_ogg_opus:"audio/webm;codecs=opus",webm_ogg_vorbis:"audio/webm;codecs=vorbis",webm_mkv_pcm:"audio/webm;codecs=pcm",mp3:"audio/mpeg",mp4:"audio/mp4",flac:"audio/flac",mpeg:"audio/mpeg"},i.getSupportedMediaRecorderCodecs=function(){var a={};return window.MediaRecorder&&Object.keys(i.defaultMimeTypesForCodecs).forEach(function(b){var c=i.defaultMimeTypesForCodecs[b];window.MediaRecorder.isTypeSupported(c)&&(a[b]=c)}),a},i.createAudioContext=function(a,b){var c={};!b&&a.targetSampleRate&&(c.sampleRate=a.targetSampleRate);var d=new j(c);return d},i.Processor=function(a,b,c){function f(b){a.debugLog&&a.debugLog("Started init. condition: "+b),H[b]=1}function j(c){H[c]&&(delete H[c],a.debugLog&&a.debugLog("Completed init. condition: "+c),0==Object.keys(H).length&&!E&&(clearTimeout(z),E=!0,F=!1,b({name:"ProcessorReady",message:"Processor is ready for action",inputSampleRate:u,targetSampleRate:a.targetSampleRate||u,sourceInfo:I,modulesInfo:J})))}function k(){clearTimeout(z),E=!1,F=!1,H={},f("sourceSetup"),f("modulesSetup")}function l(a){k(),c(a)}async function m(b,c){if(v&&b&&("closed"!=v.state&&(await v.close()),v=null),!v||"closed"==v.state)if(v=i.createAudioContext(a,c),null==a.startSuspended||a.startSuspended){try{await v.resume()}catch(a){}await v.suspend()}else await v.resume();return v}async function n(){if(a.modules)for(let b=0;b<a.modules.length;b++){let c=a.modules[b],d=o(c),e=d.moduleType,f=d.moduleName;if(1==e){let b=B+f+".js";a.debugLog&&a.debugLog("Adding audioWorklet module: "+b);try{await v.audioWorklet.addModule(b)}catch(c){console.error(c),a.debugLog&&a.debugLog("FAILED to add audioWorklet module: "+b+" - Msg.: "+c.name+", "+c.message)}}else if(2==e){let b=B+f.replace(/-worker$/,"")+"-worker.js";a.debugLog&&a.debugLog("Adding worker module: "+b)}else if(3==e)throw{name:"CreateModuleError",message:"ScriptProcessor nodes are currently not supported as modules (only source)."};else if(4==e)throw{name:"CreateModuleError",message:"AudioNodes are currently not supported as modules (you can use them as custom source)."};else throw{name:"CreateModuleError",message:"Module type unknown."}}}function o(a){var b,c,d,e;return"object"==typeof a?(b=a.type&&"worker"==a.type||a.isWorker?2:a.type&&"scriptProcessor"==a.type?3:a.type&&"audioNode"==a.type?4:1,c=a.name,d=a.setup||a.settings,e=a.preLoad||{}):(b=1,c=a,d={},e={}),{moduleType:b,moduleName:c,moduleSetup:d,modulePreLoads:e}}function p(){D=!0}function q(){D=!1}function r(b,c,h){var k=b.length;if(a.modules&&a.modules.length){var m=Array(a.modules.length),n=a.modules.length;a.modules.forEach(async function(p,q){function i(a){if(!a||null==a.data);else if(1==a.data.moduleState)C.isReady=!0,j("module-"+q),a.data.moduleInfo&&(C.moduleInfo=a.data.moduleInfo),m[q]={moduleName:C.moduleName,moduleInfo:C.moduleInfo},0==--n&&h(m);else if(9==a.data.moduleState&&!C.isTerminated){if("function"==typeof C.terminate)try{C.isTerminated=!0,C.terminate()}catch(a){C.isTerminated=!0,r({name:"TerminateError",message:"Failed to terminate module",info:a})}}else if(a.data.moduleResponse);else w.sendToModules&&(a.data.moduleEvent?w.sendToModules.forEach(function(c){b[c]&&!b[c].ignoreSendToModules&&b[c].sendToModule({ctrl:{action:"handle",data:a.data}})}):w.sendToModules.forEach(function(c){b[c]&&!b[c].ignoreSendToModules&&b[c].sendToModule({ctrl:{action:"process",data:a.data}})}));w.onmessage&&w.onmessage(a.data,b)}function r(a){var b;a.message&&0==a.message.indexOf("Uncaught {")&&(a.preventDefault(),b=JSON.parse(a.message.replace(/^Uncaught /,"")),a.message=b),A({name:"AudioModuleProcessorException",message:"Error in module: "+a.target.moduleName+" - "+(b&&b.message?b.message:"Check console for details."),module:a.target.moduleName,info:b}),F&&!E&&(j("module-"+q),l({message:"Error during setup of module: "+C.moduleName,name:"ProcessorInitError",info:b})),w.onerror&&w.onerror(a)}f("module-"+q);var s=o(p),t=s.moduleType,u=s.moduleName,w=s.moduleSetup,x={},y=Object.keys(s.modulePreLoads);await Promise.all(y.map(async function(a){var b=s.modulePreLoads[a],c=1,f=void 0;"object"==typeof b?(c=b.type&&(2==b.type||"arraybuffer"==b.type.toLowerCase())?2:1,b=b.path||b.url):0==a.indexOf("wasmFile")?c=2:0==a.indexOf("wasmBase64")&&(c=1,f=g);try{var h;if(!b||2<c)throw{name:"PreLoadError",message:"Missing 'path' (url) or unsupported type (use 1=text or 2=arraybuffer)"};else 1==c?h=await e(b):2==c&&(h=await d(b));"function"==typeof f&&(h=f(h)),x[a]=h}catch(b){throw{name:"AddModuleError",message:"Failed to pre-load data: "+a+" - name: "+u,info:b}}}));var z=w.options||{};z.preLoadResults=x;var C;if(1==t){if(!c)throw{name:"AddModuleError",message:"Source does not support 'AudioWorkletProcessor' (use only workers instead) - name: "+u};z.processorOptions||(z.processorOptions=z.setup||{}),z.processorOptions.ctxInfo||(z.processorOptions.ctxInfo={sampleRate:v.sampleRate,targetSampleRate:a.targetSampleRate}),C=new AudioWorkletNode(v,u,z),C.isReady=!1,C.moduleName=u,C.port.onmessage=i,C.onprocessorerror=r,C.sendToModule=function(a){C.isReady?C.port.postMessage(a):A({name:"AudioModuleProcessorException",message:"'sendToModule' was called before module was actually ready. Consider 'startSuspended' option maybe.'",module:C.moduleName})}}else if(2==t)z.setup||(z.setup={}),z.setup.ctxInfo||(z.setup.ctxInfo={sampleRate:v.sampleRate,targetSampleRate:a.targetSampleRate}),C=new Worker(B+u.replace(/-worker$/,"")+"-worker.js"),C.isReady=!1,C.moduleName=u,C.onmessage=i,C.onerror=r,C.sendToModule=function(a){C.isReady?C.postMessage(a):a&&a.ctrl&&"construct"==a.ctrl.action?C.postMessage(a):A({name:"AudioModuleProcessorException",message:"'sendToModule' was called before module was actually ready. Consider 'startSuspended' option maybe.",module:C.moduleName})},C.sendToModule({ctrl:{action:"construct",options:z}});else if(3==t)throw{name:"AddModuleError",message:"ScriptProcessor nodes are currently not supported as modules (only source)."};else if(4==t)throw{name:"AddModuleError",message:"AudioNodes are currently not supported as modules (you can use them as custom source)."};else throw{name:"AddModuleError",message:"Unknown module type."};if(C.moduleType=t,C.ignoreSendToModules=!1,C.deactivate=function(){C.ignoreSendToModules=!0,D&&(C.sendToModule({ctrl:{action:"stop"}}),C.sendToModule({ctrl:{action:"reset"}}))},C.activate=function(){C.ignoreSendToModules=!1,D&&C.sendToModule({ctrl:{action:"start"}})},p.handle=C,!c&&0==q){var G=b[0];if(!G.onmessage)throw{name:"AddModuleError",message:"If source is not compatible to 'AudioWorklet' it has to have a 'onmessage' event to get the processed data."};G.onmessage=function(a){a&&null!=a.data&&(a.data.moduleEvent||a.data.sourceEvent?C.sendToModule({ctrl:{action:"handle",data:a.data}}):C.sendToModule({ctrl:{action:"process",data:a.data}}))}}b[k+q]=C})}else h([])}function s(b,c,d){u=v.sampleRate,d||(d={}),a.targetSampleRate&&a.targetSampleRate!=u&&(i.isNativeStreamResamplingSupported=!1,C=u-a.targetSampleRate);var e=[b],f=[],g=!0;null==d.hasWorkletSupport?"scriptProcessor"==d.type&&(g=!1):g=d.hasWorkletSupport,r(e,g,function(a){J=a,j("modulesSetup"),t.processNodes=e;let b=!1;if(e.forEach(function(a){g&&(!a.moduleType||1==a.moduleType)&&f.push(a),a.moduleInfo&&a.moduleInfo.resamplingMode&&(b=!0)}),C&&!b)return void l({message:"Samplerate mismatch and no resampler found!",name:"ProcessorInitError"})});var k=a.destinationNode||v.destination;t.mainAudioContext=v,t.source=b,t.sourceInfo=d,I=d,c||(c={}),w=function(a,b){Promise.resolve((c.onBeforeStart||h)()).then(function(){return v.resume()}).then(function(){if(1<f.length){for(var a=1;a<f.length;a++)f[a-1].connect(f[a]);f[a-1].connect(k)}else 1==f.length?f[0].connect(k):e[0].connect&&e[0].connect(k);return(e.forEach(function(a){a.sendToModule&&a.sendToModule({ctrl:{action:"start",options:{}}})}),c.onAfterStart)?Promise.resolve(c.onAfterStart()):void 0}).then(a).catch(function(a){A({name:"ProcessorStartError",message:a.name+" - Message: "+(a.message||a)}),b&&b(a)})},x=function(a,b){Promise.resolve((c.onBeforeStop||h)()).then(function(){return e.forEach(function(a){a.disconnect&&a.disconnect(),a.sendToModule&&a.sendToModule({ctrl:{action:"stop",options:{}}})}),v.suspend()}).then(function(){if(c.onAfterStop)return Promise.resolve(c.onAfterStop())}).then(a).catch(function(a){A({name:"ProcessorStopError",message:a.name+" - Message: "+(a.message||a)}),b&&b(a)})},y=function(a,b){Promise.resolve((c.onBeforeRelease||h)()).then(function(){return e.forEach(function(a,b){a.sendToModule&&a.sendToModule({ctrl:{action:"release",options:{}}}),e[b]=null}),t.processNodes=null,t.source=null,v.close()}).then(function(){if(c.onAfterRelease)return Promise.resolve(c.onAfterRelease())}).then(a).catch(function(a){A({name:"ProcessorReleaseError",message:a.name+" - Message: "+(a.message||a)}),b&&b(a)})},j("sourceSetup")}var t=this;c||(c=i.defaultProcessorOptions.initErrorCallback),b||(b=i.defaultProcessorOptions.initSuccessCallback),a||(a={});var u,v,w,x,y,z,A=a.onerror||i.defaultProcessorOptions.onerror,B=(a.moduleFolder||i.defaultProcessorOptions.moduleFolder).replace(/\/$/,"")+"/",C=0,D=!1,E=!1,F=!1,G=a.initializerTimeout||3e3,H={},I={},J=[];if(k(),F=!0,z=setTimeout(function(){l({message:"Initialization took too long! If you expect long running init. process use option 'initializerTimeout' (ms).",name:"ProcessorInitTimeout"})},G),!i.isStreamRecorderSupported&&!a.customSourceTest&&!a.customSource){return void l({name:"NotSupportedError",message:"Cannot create audio stream recorder because there are no compatible interfaces!"})}if(a.customSourceTest){let b;i.createWhiteNoiseGeneratorNode(.1,{targetSampleRate:a.targetSampleRate}).then(function(a){return b=a,v=a.context,n()}).then(function(){s(b,{},{type:"whiteNoiseGenerator"})}).catch(function(a){l(a)})}else if(a.customSource){let b=a.customSource.node;v=b.context,n().then(function(){s(b,{onBeforeStart:a.customSource.beforeStart,onAfterStart:a.customSource.start||a.customSource.afterStart,onBeforeStop:a.customSource.stop||a.customSource.beforeStop,onAfterStop:a.customSource.afterStop,onBeforeRelease:a.customSource.beforeRelease,onAfterRelease:a.customSource.release||a.customSource.afterRelease},{type:a.customSource.type||"custom",typeData:a.customSource.typeData,hasWorkletSupport:null==a.customSource.hasWorkletSupport||a.customSource.hasWorkletSupport})}).catch(function(a){l(a)})}else{let b;i.getMicrophone(a,m).then(function(a){return b=a,n()}).then(function(){s(b.source,b.controls||{},b.info)}).catch(function(a){"string"==typeof a?l({message:a,name:"ProcessorInitError"}):l({message:a.message,name:a.name,ref:a})})}t.start=function(b,c,d){E&&!D?w(function(){var c=new Date().getTime();p(),a.onaudiostart&&a.onaudiostart({startTime:c}),b&&b()},d):c&&c()},t.stop=function(b,c,d){D?x(function(){var c=new Date().getTime();q(),a.onaudioend&&a.onaudioend({endTime:c}),b&&b()},d):c&&c()},t.release=function(b,c,d){E&&y?y(function(){k(),a.onrelease&&a.onrelease(),b&&b()},d):F?l({message:"Release was called before initialization was complete.",name:"ProcessorInitError"}):c&&c()},t.isInitialized=function(){return E},t.isInitPending=function(){return F},t.isProcessing=function(){return D}},i.getAudioDevices=function(a){return new Promise(function(b,c){(async function(){if(!navigator.mediaDevices.enumerateDevices)return c({message:"MediaDevices 'enumerateDevices' is not available! Check if context is secure (SSL, HTTPS, etc.).",name:"NotSupportedError"});var d=!1,e=void 0;navigator.mediaDevices.enumerateDevices().then(function(a){if(!d){clearTimeout(e);var c={},f={};return a.forEach(function(a){"audioinput"==a.kind?c[a.label]=a.deviceId:"audiooutput"==a.kind&&(f[a.label]=a.deviceId)}),b({input:c,output:f})}}).catch(function(a){return c(a)}),e=setTimeout(function(){return d=!0,c({message:"Media device enumeration timeout. Permission might require user interaction.",name:"TimeoutError"})},a||5e3)})()})},i.getMicrophone=function(a,b,c){return a||(a={}),b||(b=async function(b,c){var d=i.createAudioContext(a,c);if(null==a.startSuspended||a.startSuspended){try{await d.resume()}catch(a){}await d.suspend()}else await d.resume();return d}),new Promise(function(d,e){(async function(){var f=JSON.parse(JSON.stringify(i.getSupportedAudioConstraints()));f.sampleRate&&a.targetSampleRate&&(f.sampleRate=a.targetSampleRate);var g={video:!1,audio:!Object.keys(f).length||f};if(!navigator.mediaDevices.getUserMedia)return e({message:"MediaDevices 'getUserMedia' is not available! Check if context is secure (SSL, HTTPS, etc.).",name:"NotSupportedError"});var h=!1,j=void 0;navigator.mediaDevices.getUserMedia(g).then(async function(c){if(!h){clearTimeout(j);var f=i.tryNativeStreamResampling&&i.isNativeStreamResamplingSupported?await b(!1,!1):await b(!1,!0);var g;try{g=f.createMediaStreamSource(c)}catch(d){f=await b(!0,!0),g=f.createMediaStreamSource(c),d&&d.name&&"NotSupportedError"==d.name&&(i.isNativeStreamResamplingSupported=!1,a.debugLog&&a.debugLog("Native stream resampling has been deactivated - Info: "+d.message))}a.destinationNode||(a.destinationNode=f.createMediaStreamDestination());var k,l={type:"mic"};if(g.mediaStream&&g.mediaStream.getAudioTracks)try{k=g.mediaStream.getAudioTracks()[0],l.label=k.label,l.settings=k.getSettings?k.getSettings():{},l.settings.sampleRate=f.sampleRate}catch(a){}var m={onBeforeStart:function(){},onAfterStop:function(){},onAfterRelease:function(){k&&"function"==typeof k.stop&&"live"==k.readyState&&k.stop()}};return d({source:g,controls:m,info:l})}}).catch(function(a){return e(a)}),j=setTimeout(function(){return h=!0,e({message:"Media 'getUserMedia' timeout. Permission might require user interaction.",name:"TimeoutError"})},c||5e3)})()})},i.createAudioRecorder=function(a,b,c){return c||(c={}),c.codec||(c.codec="webm_ogg_opus"),new Promise(function(d,e){(async function(){try{var f=b.settings.sampleRate;if(!f)return e({message:"Sample-rate unknown! Please add correct 'sourceInfo'.",name:"AudioRecorderError"});var g=b.settings.channelCount;if(1<g)return e({message:"Sorry, but this recorder only supports MONO audio at the moment.",name:"NotSupportedError"});var h=c.mimeType||i.defaultMimeTypesForCodecs[c.codec]||i.defaultMimeTypesForCodecs.webm_ogg_opus,j=c.sampleTime||(c.chunkSize?Math.floor(1e3/f*c.chunkSize):0);if(j&&c.decodeToAudioBuffer&&console.error("WARNING: Partial decoding is not supported at the moment! It is possible but requires adding custom headers for each blob!"),!window.MediaRecorder)return e({message:"'MediaRecorder' is not available!",name:"NotSupportedError"});if(!MediaRecorder.isTypeSupported(h))return e({message:"MIME-Type '"+h+"' is not supported!",name:"NotSupportedError"});var k,l,m=new MediaRecorder(a,{mimeType:h,bitsPerSecond:2*f*g}),n=!1;m.onerror=c.onerror||console.error,c.onstart&&(m.onstart=c.onstart),c.onpause&&(m.onpause=c.onpause),c.onresume&&(m.onresume=c.onresume);var o=c.onstop;m.onstop=function(){o&&!c.decodeToAudioBuffer&&o()};var p=c.ondataavailable||c.onprocess;c.decodeToAudioBuffer?p&&(m.ondataavailable=function(a){if("inactive"==m.state&&(n=!0),a&&a.data){let b=Date.now();i.offlineAudioContextBlobDecoder(f,g,a.data,function(a){a&&p({data:a.getChannelData(0),decodeTime:Date.now()-b}),!n&&c.recordLimitMs&&Date.now()-k>=c.recordLimitMs?r():n&&o&&o()})}}):p&&(m.ondataavailable=function(a){p(a),c.recordLimitMs&&Date.now()-k>=c.recordLimitMs&&r()});var q,r=function(){q&&clearTimeout(q),l=Date.now(),"inactive"!=m.state&&m.stop()},s=function(){k=Date.now(),l=void 0,n=!1,j?m.start(j):(m.start(),c.recordLimitMs&&(q=setTimeout(r,c.recordLimitMs)))};return d({getMediaRecorder:function(){return m},mimeType:h,sourceInfo:b,sampleTime:j,start:s,stop:r})}catch(a){return console.error("AudioRecorder",a),e(a)}})()})},i.offlineAudioContextBlobDecoder=function(a,b,d,e){c(d,function(c){if(!c)e();else{var d=new OfflineAudioContext(b,c.byteLength,a);d.decodeAudioData(c,function(a){e(a)},function(a){console.error("offlineAudioContext.decodeAudioData ERROR",a),e()})}})},i.blobToArray=c,i.createLegacyMicrophoneScriptProcessor=function(a){return a||(a={}),i.getMicrophone(a,void 0).then(function(b){var c=b.source,d=c.context,f=d.sampleRate,g=a.bufferSize||2048,h=1,i=d.createScriptProcessor(g,h,h);c.connect(i);var j={node:i,type:"scriptProcessor",typeData:b.info,hasWorkletSupport:!1,start:function(){b.controls.onAfterStart&&b.controls.onAfterStart()},stop:function(){b.controls.onBeforeStop&&b.controls.onBeforeStop()},release:function(){b.controls.onAfterRelease&&b.controls.onAfterRelease()}};if(b.controls&&(b.controls.onBeforeStart&&(j.beforeStart=b.controls.onBeforeStart),b.controls.onAfterStop&&(j.afterStop=b.controls.onAfterStop),b.controls.onBeforeRelease&&(j.beforeRelease=b.controls.onBeforeRelease)),a.onaudioprocess)i.onaudioprocess=a.onaudioprocess;else{function b(a){if(a&&a.inputBuffer){var b=[a.inputBuffer.getChannelData(0)];i.onmessage({data:{samples:b,sampleRate:f,channels:h,type:b[0].constructor.name}})}}i.onaudioprocess=function(a){b(a)},i.onmessage=a.onmessage||function(){}}return j})},i.createWhiteNoiseGeneratorNode=function(a,b){b||(b={});var c=(b.moduleFolder||i.defaultProcessorOptions.moduleFolder).replace(/\/$/,"")+"/";return new Promise(function(d,e){(async function(){try{var f=i.createAudioContext(b);try{await f.resume()}catch(a){}await f.suspend();await f.audioWorklet.addModule(c+"white-noise-generator.js");var g=new AudioWorkletNode(f,"white-noise-generator",{processorOptions:{gain:a||.1}});b.onMessageCallback&&(g.port.onmessage=b.onMessageCallback),d(g)}catch(a){return e(a)}})()})},i.createFileSource=function(a,b){return b||(b={}),new Promise(function(c,d){(async function(){try{var e=i.createAudioContext(b);try{await e.resume()}catch(a){}await e.suspend();var f=e.createBufferSource();i.readFileAsBuffer(a,function(b){e.decodeAudioData(b,function(b){return f.buffer=b,f.loop=!0,c({node:f,type:"fileAudioBuffer",typeData:{fileUrl:a},start:function(){f.start()},stop:function(){f.stop()},release:function(){}})},function(a){return d(a)})},function(a){return d(a)})}catch(a){return d(a)}})()})},i.encodeWaveBuffer=function(a,b,c,d,f,g){var h=i.defaultProcessorOptions.moduleFolder.replace(/\/$/,"")+"/",j=new Worker(h+"wave-encoder-worker.js");f||(f=console.log),g||(g=console.error);var k={setup:{inputSampleRate:b,inputSampleSize:a.length,lookbackBufferMs:0}};j.onmessage=function(h){1==h.data.moduleState?j.postMessage({encode:{format:"wave",data:{samples:[a],sampleRate:b,channels:c,isFloat32:d}}}):h.data.encoderResult&&(j.terminate(),h.data.error?g({name:"EncoderError",message:h.data.error}):f(h.data.encoderResult))},j.onerror=function(a){j.terminate(),g(a)},j.postMessage({ctrl:{action:"construct",options:k}})},i.decodeAudioFile=function(a,b,c,d,e){i.readFileAsBuffer(a,function(a){var f=new OfflineAudioContext(c,a.byteLength,b);f.decodeAudioData(a,function(a){d(a)},function(a){e(a)})},function(a){e(a)})},i.decodeAudioFileToInt16Mono=function(a,b,c,d){i.decodeAudioFile(a,b,1,function(a){i.encodeWaveBuffer(a.getChannelData(0),b,1,!0,function(a){try{var b=new Int16Array(a.wav.buffer);c(b)}catch(a){d(a)}},d)},d)},i.resampleBufferViaSpeex=function(a,b,c,d,e,f,g){f||(f=console.log),g||(g=console.error);try{var h=new OfflineAudioContext(d,a.length,b),j=i.defaultProcessorOptions.moduleFolder.replace(/\/$/,"")+"/",k="speex-resample-switch";h.audioWorklet.addModule(j+k+".js").then(function(){var d={processorOptions:{ctxInfo:{sampleRate:b},targetSampleRate:c,resampleQuality:e,bufferSize:a.length}},i=new AudioWorkletNode(h,k,d);i.port.onmessage=function(b){1==b.data.moduleState?i.port.postMessage({resample:{samples:[a],isInt16:!0}}):b.data.resampleResult&&(h=null,b.data.error?g({name:"ResampleError",message:b.data.error}):f(b.data.resampleResult))},i.onprocessorerror=function(a){h=null,g(a)}})}catch(a){g(a)}},i.readFileAsBuffer=function(a,b,c){SepiaFW&&SepiaFW.files?SepiaFW.files.fetch(a,b,c,"arraybuffer"):f("arraybuffer",a,b,c)},i.readFileAsText=function(a,b,c){SepiaFW&&SepiaFW.files?SepiaFW.files.fetch(a,b,c):f("text",a,b,c)},i.addAudioElementToPage=function(a,b,c){var d=document.createElement("audio");d.src=window.URL.createObjectURL("Blob"==b.constructor.name?b:new Blob([b],{type:c||"audio/wav"})),d.setAttribute("controls","controls");var e=document.createElement("div");return e.appendChild(d),a||(a=document.body),a.appendChild(e),d};a.webAudio=i}(SepiaFW);